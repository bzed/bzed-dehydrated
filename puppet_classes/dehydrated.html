<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Puppet Class: dehydrated
  
    &mdash; Documentation by YARD 0.9.36
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "puppet_classes::dehydrated";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../puppet_class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (d)</a> &raquo;
    <span class='title'><span class='object_link'>Puppet Classes</span></span>
     &raquo; 
    <span class="title">dehydrated</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="../puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Puppet Class: dehydrated</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd><span class='object_link'><a href="dehydrated_3A_3Aparams.html" title="puppet_classes::dehydrated::params (puppet_class)">dehydrated::params</a></span></dd>
  </dl>
  
  
  <dl>
    <dt>Defined in:</dt>
    <dd>
      manifests/init.pp
    </dd>
  </dl>
</div>

  <h2>Summary</h2>
  Base class to define necessary variables and include setup classes.

<h2>Overview</h2>
<div class="docstring">
  <div class="discussion">
    <p>Base class to setup the letsencrypt certificate handling
with dehydrated.</p>

  </div>
</div>



<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code># should be sufficient in most cases.
include dehydrated

# if you are &quot;upgrading&quot; from bzed-letsencrypt,
# you might want to use these options to stay
# compatible with the old group/directory:
class { &#39;dehydrated&#39; :
  group    =&gt; &#39;letsencrypt&#39;,
  base_dir =&gt; &#39;/etc/letsencrypt&#39;,
}</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>base_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::base_dir</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The base directory where keys/csr/certs are stored.
Defaults to:</p>

<ul>
<li>on $::os[&#39;family&#39;]==&#39;Debian&#39;: /etc/dehydrated</li>
<li>on other Linux/Unix systems: /etc/pki/dehydrated</li>
<li>on windows: C:\LE_certs.</li>
</ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>crt_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>join([$base_dir, &#39;certs&#39;], $dehydrated::params::path_seperator)</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The directory where certificates are stored. Defaults to $base_dir/certs</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>csr_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>join([$base_dir, &#39;csr&#39;], $dehydrated::params::path_seperator)</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The directory where CSRs are stored. Defaults to $base_dir/csr</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>key_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>join([$base_dir, &#39;private&#39;], $dehydrated::params::path_seperator)</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The directory where pricate keys are stored. Defaults to $base_dir/private</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>user</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::user</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Linux: The user who owns the files in /etc/dehydrated.
Windows: The user who owns the files in C:\LE_Certs. Needs to be specified!</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>group</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::group</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Linux: The group which owns the files in /etc/dehydrated.
  If you have a non-root process which needs to access private keys, add its user to this group.
Windows: The group which owns the files in C:\LE_Certs. Needs to be specified!</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_user</span>
      
      
        <span class='type'>(<tt>Optional[String]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_user</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>User to run the dehydrated script as. Only used on the host that actually requests certificates.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_group</span>
      
      
        <span class='type'>(<tt>Optional[String]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_group</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Group to run the dehydrated script as. Only used on the host that actually requests certificates.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>letsencrypt_ca</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::letsencrypt_ca</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Let’s Encrypt CA to use. Defaults to v2-production. See the letsencrypt_cas parameter for a way
to specify your own Let’s Encrypt / ACME compatible CA. This configures the default CA to use, but
You can actually define different CAs for each certificate, see the dehydrated::certificate
define for details.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>letsencrypt_cas</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::letsencrypt_cas</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Hash with the definitions of the official testing and production Let’s Encrypt CAs this
puppet module was tested against.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dh_param_size</span>
      
      
        <span class='type'>(<tt>Integer[768]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dh_param_size</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Default size of the DH params we should generate. Defaults to 2048.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>challengetype</span>
      
      
        <span class='type'>(<tt>Dehydrated::Challengetype</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::challengetype</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Default challengetype to use. Defaults to &#39;dns-01&#39;. You can specify a different
challengetype for each certificate, see dehydrated::certificate.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>algorithm</span>
      
      
        <span class='type'>(<tt>Dehydrated::Algorithm</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::algorithm</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Default algorithm / elliptic-curve you want to use. Supported: rsa, secp384r1, prime256v1.
Defaults to rsa. You can specify a different algorithm for each certificate,
see dehydrated::certificate.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>key_size</span>
      
      
        <span class='type'>(<tt>Integer[768]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::key_size</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Size of the key if we create a new one.  Only used if algorithm is &#39;rsa&#39;.
You can specify a different size for each certificate; see dehydrated::certificate.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_base_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_base_dir</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host. Path where the dehydrated
script and configurations/csrs are being stored. Defaults to &#39;/opt/dehydrated&#39;.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_git_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/dehydrated&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.
Path where the dehydrated script is being checkout out into using git.
Defaults to $dehydrated_base_dir/dehydrated.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_git_tag</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_git_tag</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.
Version of the dehydrated script we want to use.
Change it on your own risk.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_git_url</span>
      
      
        <span class='type'>(<tt>Dehydrated::GitUrl</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_git_url</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.
Git url to clone dehydrated from. If you have an internal mirror/version, you can override
the default github url here.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_host</span>
      
      
        <span class='type'>(<tt>Stdlib::Fqdn</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_host</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Default setting for the host you want to request the certificates on.
Required on that host, on all others it is used as default for certificates requested
via dehydrated::certificate. You can specify a different dehydrated_host on each
certificate if you want to.
If $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host, dehydrated will be installed
and the certificate request cronjob will be setup.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_requests_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/requests&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.
Path where requests that need to be handled are being stored.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_hooks_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/hooks&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_requests_config</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/requests.json&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_wellknown_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/acme-challenges&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_alpncert_dir</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/alpn-certs&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_host_packages</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_host_packages</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_environment</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_environment</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_domain_validation_hook</span>
      
      
        <span class='type'>(<tt>Optional[Dehydrated::Hook]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_domain_validation_hook</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Only used if $trusted[&#39;certname&#39;] == $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_hook</span>
      
      
        <span class='type'>(<tt>Dehydrated::Hook</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${challengetype}.sh&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Name of the hook script dehydrated will use to validate the authorization request. The hook script
must live in the $dehydrated_hooks_dir on $dehydrated::dehydrated_host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_contact_email</span>
      
      
        <span class='type'>(<tt>Optional[Dehydrated::Email]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::dehydrated_contact_email</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Contact email address for created accounts. We&#39;ll create one account for each
puppet host.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>accounts_per_agent</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Create one ACME account per puppet client (true; the default), or one account globally.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_status_file</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/status.json&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>File the dehydrated job runner will dump its status into. Pretty printed JSON.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dehydrated_monitoring_status_file</span>
      
      
        <span class='type'>(<tt>Stdlib::Absolutepath</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>&quot;${dehydrated_base_dir}/monitoring.status&quot;</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Status file for monitoring with check_statusfile, see README.md for details.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_user</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::manage_user</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Create $dehydrated_user/$dehydrated_group and $user/$group if necessary.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manage_packages</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::manage_packages</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Install required packages using ensure_packages?
Should be safe to leave enabled in most cases.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>pki_packages</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::pki_packages</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Required packages to create /etc/pki. Not really used yet.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>packages</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::packages</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The list of packages we actually need to install to make this module work properly.
You are free to modify this list if you need to.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>certificates</span>
      
      
        <span class='type'>(<tt>Array[Variant[Dehydrated::DN, Tuple[Dehydrated::DN, Array[Dehydrated::DN]]]]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>[]</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Allows to request certificates instead of using dehydrated::certificate.
The puppet definition of this rather complex parameter is
    Array[Variant[Dehydrated::DN, Tuple[Dehydrated::DN, Array[Dehydrated::DN]]]]
So basically, you need to specify an Array. Contents are either a</p>

<ul>
<li>distinguished name</li>
<li>tuple with [distinguished name, array of distinguished names]
The first case requests a default certificate. The tuple version will request a
SAN certificate.</li>
</ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>build_pfx_files</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::build_pfx_files</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Create PKCS12 container with key, certificate and ca certificates.
Defaults to true on windows, to false on all other OS.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>preferred_chain</span>
      
      
        <span class='type'>(<tt>Optional[String]</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>$dehydrated::params::preferred_chain</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Preferred dehydrated CA chain to use</p>
</div>
      
    </li>
  
</ul>



</div><div class="method_details_list">
  <table class="source_code">
    <tr>
      <td>
        <pre class="lines">


139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306</pre>
      </td>
      <td>
        <pre class="code"><span class="info file"># File 'manifests/init.pp', line 139</span>

class dehydrated (
  Stdlib::Absolutepath $base_dir = $dehydrated::params::base_dir,
  Stdlib::Absolutepath $crt_dir = join([$base_dir, &#39;certs&#39;], $dehydrated::params::path_seperator),
  Stdlib::Absolutepath $csr_dir = join([$base_dir, &#39;csr&#39;], $dehydrated::params::path_seperator),
  Stdlib::Absolutepath $key_dir = join([$base_dir, &#39;private&#39;], $dehydrated::params::path_seperator),
  String $user = $dehydrated::params::user,
  String $group = $dehydrated::params::group,
  Optional[String] $dehydrated_user = $dehydrated::params::dehydrated_user,
  Optional[String] $dehydrated_group = $dehydrated::params::dehydrated_group,

  String $letsencrypt_ca = $dehydrated::params::letsencrypt_ca,
  Hash $letsencrypt_cas = $dehydrated::params::letsencrypt_cas,
  Integer[768] $dh_param_size = $dehydrated::params::dh_param_size,
  Dehydrated::Challengetype $challengetype = $dehydrated::params::challengetype,
  Dehydrated::Algorithm $algorithm = $dehydrated::params::algorithm,
  Integer[768] $key_size = $dehydrated::params::key_size,

  Stdlib::Absolutepath $dehydrated_base_dir = $dehydrated::params::dehydrated_base_dir,
  Stdlib::Absolutepath $dehydrated_git_dir = &quot;${dehydrated_base_dir}/dehydrated&quot;,
  String $dehydrated_git_tag = $dehydrated::params::dehydrated_git_tag,
  Dehydrated::GitUrl $dehydrated_git_url = $dehydrated::params::dehydrated_git_url,
  Stdlib::Fqdn $dehydrated_host = $dehydrated::params::dehydrated_host,
  Stdlib::Absolutepath $dehydrated_requests_dir = &quot;${dehydrated_base_dir}/requests&quot;,
  Stdlib::Absolutepath $dehydrated_hooks_dir = &quot;${dehydrated_base_dir}/hooks&quot;,
  Stdlib::Absolutepath $dehydrated_requests_config = &quot;${dehydrated_base_dir}/requests.json&quot;,
  Stdlib::Absolutepath $dehydrated_wellknown_dir = &quot;${dehydrated_base_dir}/acme-challenges&quot;,
  Stdlib::Absolutepath $dehydrated_alpncert_dir = &quot;${dehydrated_base_dir}/alpn-certs&quot;,
  Stdlib::Absolutepath $dehydrated_status_file = &quot;${dehydrated_base_dir}/status.json&quot;,
  Stdlib::Absolutepath $dehydrated_monitoring_status_file = &quot;${dehydrated_base_dir}/monitoring.status&quot;,
  Array $dehydrated_host_packages = $dehydrated::params::dehydrated_host_packages,
  Hash $dehydrated_environment = $dehydrated::params::dehydrated_environment,
  Optional[Dehydrated::Hook] $dehydrated_domain_validation_hook = $dehydrated::params::dehydrated_domain_validation_hook,
  Dehydrated::Hook $dehydrated_hook = &quot;${challengetype}.sh&quot;,
  Optional[Dehydrated::Email] $dehydrated_contact_email = $dehydrated::params::dehydrated_contact_email,
  Boolean $accounts_per_agent = true,

  Boolean $manage_user = $dehydrated::params::manage_user,
  Boolean $manage_packages = $dehydrated::params::manage_packages,

  Array $pki_packages = $dehydrated::params::pki_packages,
  Array $packages = $dehydrated::params::packages,
  Array[Variant[Dehydrated::DN, Tuple[Dehydrated::DN, Array[Dehydrated::DN]]]] $certificates = [],

  Boolean $build_pfx_files = $dehydrated::params::build_pfx_files,
  Optional[String] $preferred_chain = $dehydrated::params::preferred_chain,
) inherits dehydrated::params {
  require dehydrated::setup

  $certificates.each | $certificate | {
    if ($certificate =~ Tuple[Dehydrated::DN, Array[Dehydrated::DN]]) {
      dehydrated::certificate { $certificate[0] :
        subject_alternative_names =&gt; $certificate[1],
      }
    } else {
      dehydrated::certificate { $certificate : }
    }
  }

  $_fqdn_based_config = {
    &#39;dehydrated_contact_email&#39; =&gt; $dehydrated_contact_email,
  }

  $dehydrated_domains = $facts[&#39;dehydrated_domains&#39;]
  $ready_for_merge = $dehydrated_domains.map |Dehydrated::DN $_dn, Hash $_config| {
    $_base_filename = $_config[&#39;base_filename&#39;]
    $_dh_param_size = $_config[&#39;dh_param_size&#39;]
    $_csr = $_config[&#39;csr&#39;]
    $_crt_serial = $_config[&#39;crt_serial&#39;]
    $_subject_alternative_names = $_config[&#39;subject_alternative_names&#39;]
    $_dehydrated_host = $_config[&#39;dehydrated_host&#39;]

    dehydrated::certificate::dh { $_base_filename :
      dn            =&gt; $_dn,
      dh_param_size =&gt; $_dh_param_size,
    }

    $request_name = join(
      concat([$trusted[&#39;certname&#39;], $_dn],
        $_subject_alternative_names
      ),
    &#39;-&#39;)

    $_request_config = merge($_fqdn_based_config, $_config)
    if $_csr =~ Dehydrated::CSR {
      @@dehydrated::certificate::request { $request_name :
        request_fqdn    =&gt; $trusted[&#39;certname&#39;],
        config          =&gt; $_request_config,
        dn              =&gt; $_dn,
        dehydrated_host =&gt; $_dehydrated_host,
      }
    }

    $transfer_query = @(&quot;EOF&quot;:json)
      [&quot;from&quot;, &quot;resources&quot;,
        [ &quot;extract&quot;,
          [
            &quot;title&quot;,
            &quot;certname&quot;,
            &quot;parameters.file_type&quot;,
            &quot;parameters.request_dn&quot;,
            &quot;parameters.file_content&quot;
          ],
          [
            &quot;and&quot;,
            [ &quot;=&quot;, &quot;certname&quot;, &quot;${_dehydrated_host}&quot;],
            [ &quot;=&quot;, &quot;type&quot;, &quot;Dehydrated::Certificate::Transfer&quot; ],
            [ &quot;=&quot;, &quot;parameters.request_fqdn&quot;, &quot;${trusted[&#39;certname&#39;]}&quot; ],
            [ &quot;=&quot;, &quot;parameters.request_base_filename&quot;, &quot;${_base_filename}&quot; ],
            [ &quot;=&quot;, &quot;exported&quot;, true ]
          ]
        ]
      ]
      | EOF

    $transfer_data = puppetdb_query($transfer_query)
    $transfer_data.each |$transfer| {
      if ($transfer[&#39;parameters.file_type&#39;] == &#39;ocsp&#39;) {
        $content = base64(&#39;decode&#39;, $transfer[&#39;parameters.file_content&#39;])
      } else {
        $content = $transfer[&#39;parameters.file_content&#39;]
      }

      $filenames = {
        &#39;ca&#39;   =&gt; &quot;${crt_dir}/${_base_filename}_ca.pem&quot;,
        &#39;crt&#39;  =&gt; &quot;${crt_dir}/${_base_filename}.crt&quot;,
        &#39;ocsp&#39; =&gt; &quot;${crt_dir}/${_base_filename}.crt.ocsp&quot;,
      }

      $filename = $filenames[$transfer[&#39;parameters.file_type&#39;]]
      file { $filename:
        ensure  =&gt; file,
        owner   =&gt; $user,
        group   =&gt; $group,
        mode    =&gt; &#39;0644&#39;,
        content =&gt; $content,
      }
    }

    # mark as ready for merge in case we have 3 files to transfer.
    if length($transfer_data) == 3 {
      $_dn
    } else {
      undef
    }
  }.delete_undef_values()

  if ($dehydrated_host == $trusted[&#39;certname&#39;]) {
    require dehydrated::setup::dehydrated_host
    include dehydrated::setup::requests
    Class[&#39;dehydrated::setup::dehydrated_host&#39;] -&gt; Class[&#39;dehydrated::setup::requests&#39;]

    if &#39;dehydrated_certificates&#39; in $facts {
      $dehydrated_certificates = $facts[&#39;dehydrated_certificates&#39;]
      $dehydrated_certificates.each |Stdlib::Fqdn $_request_fqdn, Hash $_certificate_configs| {
        $_certificate_configs.each |Dehydrated::DN $_request_dn, $_request_config| {
          $_request_base_dir = $_request_config[&#39;request_base_dir&#39;]
          $_request_base_filename = $_request_config[&#39;base_filename&#39;]
          dehydrated::certificate::collect { &quot;${_request_fqdn}-${_request_dn}&quot; :
            request_dn            =&gt; $_request_dn,
            request_fqdn          =&gt; $_request_fqdn,
            request_base_dir      =&gt; $_request_base_dir,
            request_base_filename =&gt; $_request_base_filename,
          }
        }
      }
    }
  }
}</pre>
      </td>
    </tr>
  </table>
</div>
</div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>